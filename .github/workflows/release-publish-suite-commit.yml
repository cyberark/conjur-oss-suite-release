on:
  release:
    types:
      - published

jobs:
  release-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go 1.13
        uses: actions/setup-go@v1
        with:
          go-version: 1.13

      - name: Check out code into the Go module directory
        uses: actions/checkout@v2

      - name: Create k8s KinD Cluster
        uses: helm/kind-action@v1.0.0-alpha.3

      - name: Install Helm
        uses: azure/setup-helm@v1

      - name: Add Helm 'stable' repository
        run: helm repo add stable https://kubernetes-charts.storage.googleapis.com/ && helm repo update

      - name: Run releases test
        working-directory: ./release-testing
        run: ./test

  persist-new-suite-yml:
    runs-on: ubuntu-latest
    needs: release-tests

    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        ref: master

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Permanently save the new suite release
      run: |
        mkdir -p releases

        tag_name=${{github.event.release.tag_name}}
        echo "Tag: $tag_name"

        version=$(echo "$tag_name" | sed 's/^v//')
        echo "Version: $version"

        new_suite_version_yml="releases/suite_${version}.yml"
        echo "Suite target file: $new_suite_version_yml"

        cp suite.yml "${new_suite_version_yml}"

        git add "${new_suite_version_yml}"
        git commit -m "Release ${version} auto-commit of new release"

    - name: Push files
      run: |
        git push "https://${{ github.actor }}:${{secrets.GITHUB_TOKEN}}@github.com/${{ github.repository }}.git" HEAD:master
